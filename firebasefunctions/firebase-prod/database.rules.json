{
  "rules": {
    "users": {
    	"$uid": {
        ".write": "auth.uid === $uid",
        ".read": "auth.uid === $uid",
        "$field": {
          ".read": "($field === 'stripeId' && auth.uid === $uid) || root.child('users').child(auth.uid).exists()",
        	".write": "auth.uid === $uid || $field === 'pendingschedule' || $field === 'schedule' || $field === 'rating' || $field === 'sessions' || $field === 'clients' || $field === 'trainers' || $field === 'requests' || root.child('users').child($uid).child('managerKey').val() === auth.uid"
        }
      }
    },
  	"gyms": {
      ".read": true,
      "$gymKey": {
        "$field": {
        	".write": "$field === 'groupSessions' && root.child('users').child(auth.uid).exists()",
          "$trainerKey": {
            ".write": "root.child('gyms').child($gymKey).child('managerKey').val() === auth.uid || auth.uid === $trainerKey",
            "$trainerField": {
              ".write": "$trainerField === 'rating' && root.child('users').child(auth.uid).exists()"
            }
          }
        }
      }
    },
    "pendingSessions": {
      ".read": "root.child('users').child(auth.uid).exists()",
      "$sessionKey": {
        ".write": "(data.child('client').val() === auth.uid || data.child('trainer').val() === auth.uid || newData.child('client').val() == auth.uid || newData.child('trainer').val() == auth.uid) && (!newData.child('clientStripe').exists() || root.child('users').child(newData.child('client').val()).child('stripeId').val() === newData.child('clientStripe').val()) && (!newData.child('trainerStripe').exists() || root.child('users').child(newData.child('trainer').val()).child('stripeId').val() === newData.child('trainerStripe').val())",
        "$field": {
        	".write": "($field === 'trainerStripe' && (root.child('users').child(newData.child('trainer').val()).child('stripeId').val() === newData.child('trainerStripe').val())) || ($field === 'clientStripe' && (root.child('users').child(newData.child('client').val()).child('stripeId').val() === newData.child('clientStripe').val())) || ($field === 'rate' && (!data.exists() || !newData.exists()))"
        }
      },
      ".indexOn": ["trainer", "client"]
    },
    "trainSessions": {
      ".read": "root.child('users').child(auth.uid).exists()",
      "$sessionKey": {
        ".write": "(data.child('client').val() === auth.uid || data.child('trainer').val() === auth.uid || newData.child('client').val() == auth.uid || newData.child('trainer').val() == auth.uid) && (!newData.child('clientStripe').exists() || root.child('users').child(newData.child('client').val()).child('stripeId').val() === newData.child('clientStripe').val()) && (!newData.child('trainerStripe').exists() || root.child('users').child(newData.child('trainer').val()).child('stripeId').val() === newData.child('trainerStripe').val())",
        "$field": {
          ".write": "($field === 'rate' && (!data.exists() || !newData.exists())) || ($field === 'clientStripe' && (!data.exists() || !newData.exists()) && root.child('users').child(newData.child('client').val()).child('stripeId').val() === newData.child('clientStripe').val()) || (($field === 'clientReady' || $field === 'clientEnd') && root.child('trainSessions').child($sessionKey).child('client').val() === auth.uid) || ($field === 'trainerStripe' && (!data.exists() || !newData.exists()) && root.child('users').child(newData.child('trainer').val()).child('stripeId').val() === newData.child('trainerStripe').val()) || (($field === 'trainerReady' || $field === 'trainerEnd') && root.child('trainSessions').child($sessionKey).child('client').val() == auth.uid)"
        }
      },
      ".indexOn": ["trainer", "client"]
    },
    "groupSessions": {
      ".read": "root.child('users').child(auth.uid).exists()",
      "$sessionKey": {
        ".write": "(data.child('trainer').val() === auth.uid || newData.child('trainer').val() === auth.uid || data.child('clients').child(auth.uid).exists()) && (!newData.child('trainerStripe').exists() || root.child('users').child(newData.child('trainer').val()).child('stripeId').val() === newData.child('trainerStripe').val())",
        "$field": {
          ".write": "$field !== 'trainerStripe' || root.child('users').child(newData.child('trainer').val()).child('stripeId').val() === newData.child('trainerStripe').val()"
        }
      },
      ".indexOn": ["trainer", "client", "clientCount"]
    },
    "pastSessions": {
      "$uid": {
        ".read": "auth.uid === $uid || auth.uid === root.child('users').child($uid).child('managerKey').val()",
        ".write": "auth.uid === $uid || root.child('users').child(auth.uid).exists()",
        "$sessionKey": {
          "$session": {
            "$field": {
        			".write": "($field === 'clientRating' && root.child('pastSessions').child($uid).child($sessionKey).child('session').child('client').val() === auth.uid) || ($field === 'trainerRating' && root.child('pastSessions').child($uid).child($sessionKey).child('session').child('trainer').val() === auth.uid)"
            }  
          }
      	}
      }
    },
    "reportSessions": {
      ".read": false,
      "$sessionKey": {
        "$uid": {
          ".write": "auth.uid === $uid"
        }
      }
    },
    "cancelSessions": {
    	".read": false,
      "$uid": {
        ".write": "auth.uid === $uid",
      }
    },
    "trainerRequests": {
      ".read": "root.child('users').child(auth.uid).exists()",
      "$uid": {
      	".write": "auth.uid === $uid || (root.child('users').child(auth.uid).exists() && !data.exists())",
        "$requestKey": {
          ".write": "auth.uid === $uid || (root.child('users').child(auth.uid).exists() && !data.exists())"
        }    
      }
    },
    "clientRequests": {
      ".read": "root.child('users').child(auth.uid).exists()",
      "$uid": {
      	".write": "auth.uid === $uid || (root.child('users').child(auth.uid).exists() && !data.exists())",
        "$requestKey": {
          ".write": "auth.uid === $uid || (root.child('users').child(auth.uid).exists() && !data.exists())"
        }
      }
    }
  }
}